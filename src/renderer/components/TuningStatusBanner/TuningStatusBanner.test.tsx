import React from 'react';
import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { TuningStatusBanner } from './TuningStatusBanner';
import type { TuningSession } from '@shared/types/tuning.types';

const baseSession: TuningSession = {
  profileId: 'profile-1',
  phase: 'filter_flight_pending',
  startedAt: '2026-02-10T10:00:00Z',
  updatedAt: '2026-02-10T10:00:00Z',
};

describe('TuningStatusBanner', () => {
  const onAction = vi.fn();
  const onViewGuide = vi.fn();
  const onReset = vi.fn();

  const onFixSettings = vi.fn();

  function renderBanner(
    session: TuningSession = baseSession,
    flashErased?: boolean,
    overrides?: { bbSettingsOk?: boolean; fixingSettings?: boolean; flashUsedSize?: number | null }
  ) {
    return render(
      <TuningStatusBanner
        session={session}
        flashErased={flashErased}
        flashUsedSize={overrides?.flashUsedSize}
        bbSettingsOk={overrides?.bbSettingsOk}
        fixingSettings={overrides?.fixingSettings}
        onAction={onAction}
        onViewGuide={onViewGuide}
        onReset={onReset}
        onFixSettings={onFixSettings}
      />
    );
  }

  it('renders step indicators', () => {
    renderBanner();

    expect(screen.getByText('Prepare')).toBeInTheDocument();
    expect(screen.getByText('Filter Flight')).toBeInTheDocument();
    expect(screen.getByText('Filter Tune')).toBeInTheDocument();
    expect(screen.getByText('PID Flight')).toBeInTheDocument();
    expect(screen.getByText('PID Tune')).toBeInTheDocument();
    expect(screen.getByText('Verify')).toBeInTheDocument();
  });

  it('shows filter_flight_pending UI', () => {
    renderBanner();

    expect(
      screen.getByText(/Erase Blackbox data, then fly the filter test flight/)
    ).toBeInTheDocument();
    expect(screen.getByText('Erase Flash')).toBeInTheDocument();
    expect(screen.getByText('View Flight Guide')).toBeInTheDocument();
  });

  it('shows filter_analysis UI', () => {
    renderBanner({ ...baseSession, phase: 'filter_analysis' });

    expect(screen.getByText(/Run the Filter Wizard/)).toBeInTheDocument();
    expect(screen.getByText('Open Filter Wizard')).toBeInTheDocument();
  });

  it('shows pid_flight_pending UI', () => {
    renderBanner({ ...baseSession, phase: 'pid_flight_pending' });

    expect(screen.getByText(/fly the PID test flight/)).toBeInTheDocument();
    expect(screen.getByText('Erase Flash')).toBeInTheDocument();
    expect(screen.getByText('View Flight Guide')).toBeInTheDocument();
  });

  it('shows pid_analysis UI', () => {
    renderBanner({ ...baseSession, phase: 'pid_analysis' });

    expect(screen.getByText(/Run the PID Wizard/)).toBeInTheDocument();
    expect(screen.getByText('Open PID Wizard')).toBeInTheDocument();
  });

  it('shows completed UI', () => {
    renderBanner({ ...baseSession, phase: 'completed' });

    expect(screen.getByText(/Tuning complete/)).toBeInTheDocument();
    expect(screen.getByText('Dismiss')).toBeInTheDocument();
  });

  it('calls onAction with correct action when primary button clicked', async () => {
    const user = userEvent.setup();
    renderBanner({ ...baseSession, phase: 'filter_analysis' });

    await user.click(screen.getByText('Open Filter Wizard'));
    expect(onAction).toHaveBeenCalledWith('open_filter_wizard');
  });

  it('calls onViewGuide when View Flight Guide clicked', async () => {
    const user = userEvent.setup();
    renderBanner();

    await user.click(screen.getByText('View Flight Guide'));
    expect(onViewGuide).toHaveBeenCalledWith('filter');
  });

  it('calls onViewGuide with pid mode for pid phases', async () => {
    const user = userEvent.setup();
    renderBanner({ ...baseSession, phase: 'pid_flight_pending' });

    await user.click(screen.getByText('View Flight Guide'));
    expect(onViewGuide).toHaveBeenCalledWith('pid');
  });

  it('calls onReset when Reset Session clicked', async () => {
    const user = userEvent.setup();
    renderBanner();

    await user.click(screen.getByText('Reset Session'));
    expect(onReset).toHaveBeenCalled();
  });

  it('does not show View Flight Guide for phases without guideTip', () => {
    renderBanner({ ...baseSession, phase: 'filter_analysis' });

    expect(screen.queryByText('View Flight Guide')).not.toBeInTheDocument();
  });

  it('shows download log button for filter_log_ready', async () => {
    const user = userEvent.setup();
    renderBanner({ ...baseSession, phase: 'filter_log_ready' });

    expect(screen.getByText(/Download the Blackbox log/)).toBeInTheDocument();
    await user.click(screen.getByText('Download Log'));
    expect(onAction).toHaveBeenCalledWith('download_log');
  });

  it('shows download log button for pid_log_ready', async () => {
    const user = userEvent.setup();
    renderBanner({ ...baseSession, phase: 'pid_log_ready' });

    expect(screen.getByText(/Download the Blackbox log/)).toBeInTheDocument();
    await user.click(screen.getByText('Download Log'));
    expect(onAction).toHaveBeenCalledWith('download_log');
  });

  it('shows flash erased state for filter_flight_pending', async () => {
    const user = userEvent.setup();
    renderBanner(baseSession, true);

    expect(
      screen.getByText(/Flash erased! Disconnect your drone and fly the filter test flight/)
    ).toBeInTheDocument();
    // Primary button should be "View Flight Guide", not "Erase Flash"
    expect(screen.queryByText('Erase Flash')).not.toBeInTheDocument();
    const guideBtn = screen.getByText('View Flight Guide');
    expect(guideBtn.className).toContain('wizard-btn-primary');
    await user.click(guideBtn);
    expect(onViewGuide).toHaveBeenCalledWith('filter');
  });

  it('advances step indicator after flash erased in filter_flight_pending', () => {
    const { container } = renderBanner(baseSession, true);

    // "Prepare" (step 1) should be done (checkmark), "Filter Flight" (step 2) should be current
    const steps = container.querySelectorAll('.tuning-status-step');
    expect(steps[0].className).toContain('done');
    expect(steps[1].className).toContain('current');
  });

  it('shows flash erased state for pid_flight_pending', async () => {
    const user = userEvent.setup();
    renderBanner({ ...baseSession, phase: 'pid_flight_pending' }, true);

    expect(
      screen.getByText(/Flash erased! Disconnect your drone and fly the PID test flight/)
    ).toBeInTheDocument();
    expect(screen.queryByText('Erase Flash')).not.toBeInTheDocument();
    const guideBtn = screen.getByText('View Flight Guide');
    await user.click(guideBtn);
    expect(onViewGuide).toHaveBeenCalledWith('pid');
  });

  it('does not show flash erased state when flashErased is false', () => {
    renderBanner(baseSession, false);

    expect(screen.getByText('Erase Flash')).toBeInTheDocument();
    expect(screen.queryByText(/Flash erased!/)).not.toBeInTheDocument();
  });

  it('does not show flash erased state for non-flight-pending phases', () => {
    renderBanner({ ...baseSession, phase: 'filter_analysis' }, true);

    expect(screen.queryByText(/Flash erased!/)).not.toBeInTheDocument();
    expect(screen.getByText('Open Filter Wizard')).toBeInTheDocument();
  });

  it('shows downloading state when downloading prop is true', () => {
    render(
      <TuningStatusBanner
        session={{ ...baseSession, phase: 'filter_log_ready' }}
        onAction={onAction}
        onViewGuide={onViewGuide}
        onReset={onReset}
        downloading
      />
    );

    expect(screen.getByText('Downloading...')).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /Downloading/ })).toBeDisabled();
  });

  it('shows download progress percentage when downloadProgress is set', () => {
    render(
      <TuningStatusBanner
        session={{ ...baseSession, phase: 'filter_log_ready' }}
        onAction={onAction}
        onViewGuide={onViewGuide}
        onReset={onReset}
        downloading
        downloadProgress={42}
      />
    );

    expect(screen.getByText('Downloading... 42%')).toBeInTheDocument();
  });

  it('disables primary button when downloading', () => {
    render(
      <TuningStatusBanner
        session={{ ...baseSession, phase: 'pid_log_ready' }}
        onAction={onAction}
        onViewGuide={onViewGuide}
        onReset={onReset}
        downloading
      />
    );

    expect(screen.getByRole('button', { name: /Downloading/ })).toBeDisabled();
  });

  it('shows filter_applied UI with Continue button and PID guide', async () => {
    const user = userEvent.setup();
    renderBanner({ ...baseSession, phase: 'filter_applied' });

    expect(screen.getByText(/Filters applied/)).toBeInTheDocument();
    expect(screen.getByText('Continue')).toBeInTheDocument();
    expect(screen.getByText('View Flight Guide')).toBeInTheDocument();

    await user.click(screen.getByText('Continue'));
    expect(onAction).toHaveBeenCalledWith('erase_flash');
  });

  it('shows pid_applied UI with Erase & Verify and Skip buttons', async () => {
    const user = userEvent.setup();
    renderBanner({ ...baseSession, phase: 'pid_applied' });

    expect(screen.getByText(/PIDs applied/)).toBeInTheDocument();
    expect(screen.getByText('Erase & Verify')).toBeInTheDocument();
    expect(screen.getByText('Skip & Complete')).toBeInTheDocument();

    await user.click(screen.getByText('Erase & Verify'));
    expect(onAction).toHaveBeenCalledWith('prepare_verification');
  });

  it('shows verification_pending UI with Download Log', async () => {
    const user = userEvent.setup();
    renderBanner({ ...baseSession, phase: 'verification_pending' });

    expect(screen.getByText(/Download the verification hover log/)).toBeInTheDocument();
    expect(screen.getByText('Download Log')).toBeInTheDocument();
    expect(screen.getByText('Skip & Complete')).toBeInTheDocument();

    await user.click(screen.getByText('Download Log'));
    expect(onAction).toHaveBeenCalledWith('download_log');
  });

  it('shows verification_pending UI with Analyze when log downloaded', async () => {
    const user = userEvent.setup();
    renderBanner({ ...baseSession, phase: 'verification_pending', verificationLogId: 'log-ver' });

    expect(screen.getByText(/Verification log ready/)).toBeInTheDocument();
    expect(screen.getByText('Analyze Verification')).toBeInTheDocument();

    await user.click(screen.getByText('Analyze Verification'));
    expect(onAction).toHaveBeenCalledWith('analyze_verification');
  });

  it('calls skip_verification from verification_pending', async () => {
    const user = userEvent.setup();
    renderBanner({ ...baseSession, phase: 'verification_pending' });

    await user.click(screen.getByText('Skip & Complete'));
    expect(onAction).toHaveBeenCalledWith('skip_verification');
  });

  // Blackbox settings pre-flight warning tests

  it('shows BB warning during filter_flight_pending with bbSettingsOk=false', () => {
    renderBanner(baseSession, false, { bbSettingsOk: false });

    expect(screen.getByText(/Blackbox settings need to be fixed/)).toBeInTheDocument();
    expect(screen.getByText('Fix Settings')).toBeInTheDocument();
  });

  it('shows BB warning during pid_flight_pending with bbSettingsOk=false', () => {
    renderBanner({ ...baseSession, phase: 'pid_flight_pending' }, false, { bbSettingsOk: false });

    expect(screen.getByText(/Blackbox settings need to be fixed/)).toBeInTheDocument();
  });

  it('does not show BB warning when bbSettingsOk=true', () => {
    renderBanner(baseSession, false, { bbSettingsOk: true });

    expect(screen.queryByText(/Blackbox settings need to be fixed/)).not.toBeInTheDocument();
  });

  it('does not show BB warning for non-flight-pending phases', () => {
    renderBanner({ ...baseSession, phase: 'filter_analysis' }, false, { bbSettingsOk: false });

    expect(screen.queryByText(/Blackbox settings need to be fixed/)).not.toBeInTheDocument();
  });

  it('does not show BB warning after flash erased', () => {
    renderBanner(baseSession, true, { bbSettingsOk: false });

    expect(screen.queryByText(/Blackbox settings need to be fixed/)).not.toBeInTheDocument();
  });

  it('calls onFixSettings when Fix Settings clicked in warning', async () => {
    const user = userEvent.setup();
    renderBanner(baseSession, false, { bbSettingsOk: false });

    await user.click(screen.getByText('Fix Settings'));
    expect(onFixSettings).toHaveBeenCalled();
  });

  // flashUsedSize-based erased state tests

  it('shows erased state when flash is physically empty on reconnect (flashUsedSize=0)', () => {
    renderBanner(baseSession, false, { flashUsedSize: 0 });

    expect(
      screen.getByText(/Flash erased! Disconnect your drone and fly the filter test flight/)
    ).toBeInTheDocument();
    expect(screen.queryByText('Erase Flash')).not.toBeInTheDocument();
  });

  it('shows Erase Flash when flash has data (flashUsedSize > 0)', () => {
    renderBanner(baseSession, false, { flashUsedSize: 1000 });

    expect(screen.getByText('Erase Flash')).toBeInTheDocument();
    expect(screen.queryByText(/Flash erased!/)).not.toBeInTheDocument();
  });

  it('shows Erase Flash when flashUsedSize is null (loading/unknown)', () => {
    renderBanner(baseSession, false, { flashUsedSize: null });

    expect(screen.getByText('Erase Flash')).toBeInTheDocument();
    expect(screen.queryByText(/Flash erased!/)).not.toBeInTheDocument();
  });

  it('shows erased state for pid_flight_pending when flash is empty', () => {
    renderBanner({ ...baseSession, phase: 'pid_flight_pending' }, false, { flashUsedSize: 0 });

    expect(
      screen.getByText(/Flash erased! Disconnect your drone and fly the PID test flight/)
    ).toBeInTheDocument();
    expect(screen.queryByText('Erase Flash')).not.toBeInTheDocument();
  });

  it('does not show erased state for non-flight-pending phase even with flashUsedSize=0', () => {
    renderBanner({ ...baseSession, phase: 'filter_analysis' }, false, { flashUsedSize: 0 });

    expect(screen.queryByText(/Flash erased!/)).not.toBeInTheDocument();
    expect(screen.getByText('Open Filter Wizard')).toBeInTheDocument();
  });

  it('shows erased state with flight guide for verification_pending after erase', () => {
    renderBanner({ ...baseSession, phase: 'verification_pending' }, true);

    expect(screen.getByText(/Flash erased! Disconnect and fly a 30-60s hover/)).toBeInTheDocument();
    expect(screen.getByText('View Flight Guide')).toBeInTheDocument();
    expect(screen.getByText('Skip & Complete')).toBeInTheDocument();
    expect(screen.queryByText('Download Log')).not.toBeInTheDocument();
  });

  it('shows Download Log for verification_pending when flash has data (reconnect after flight)', () => {
    renderBanner({ ...baseSession, phase: 'verification_pending' }, false, { flashUsedSize: 1000 });

    expect(screen.getByText('Download Log')).toBeInTheDocument();
    expect(screen.queryByText('View Flight Guide')).not.toBeInTheDocument();
  });
});
